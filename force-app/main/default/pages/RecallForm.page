<apex:page controller="RecallFormController" showHeader="false" standardStyleSheets="false" docType="html-5.0">
<html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
	<script type="text/javascript">
     var __sfdcSessionId = '{!GETSESSIONID()}';
	</script>
	<script src="/soap/ajax/40.0/connection.js" type="text/javascript"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwf3bT7BhOz_-EAqbdx4sRVkhHICPd3Qw&libraries=places"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
	<script src="{!$Resource.ngMap}"></script>
	<script>

		var app = angular.module('StericylcleDemoApp',['ngMap']);

		app.factory('VFRemotingFactory',function($q,$rootScope){  
	       var factory = {};  
	       factory.registerRecall = function(formData){  
	           var deferred = $q.defer();  
	           registerRecall(function(result){  
	               $rootScope.$apply(function(){  
	               	console.log(result);
	                   deferred.resolve(JSON.parse( result )); 
	               });  
	           }, formData);  
	           return deferred.promise;  
	       };



	       function registerRecall(callback, formData){  
		       Visualforce.remoting.Manager.invokeAction(  
		           '{!$RemoteAction.RecallFormController.registerRecall}', formData,
		           callback,  
		           {escape: false}  
		       );
		   }
		   return factory;
   		});
		
		app.controller('FormCtrl',function($scope,VFRemotingFactory){

			$scope.googleMapsUrl="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwf3bT7BhOz_-EAqbdx4sRVkhHICPd3Qw&libraries=places";
			$scope.sessionId = '{!$API.Session_Id}';

			$scope.addAttachment = function(recordID){
			    var reader = new FileReader();
			    var attachFile = document.getElementById('file-upload-input-01').files[0];

			    if(attachFile == undefined){
			        console.log('no file');
			        return;
			    }

			    if(attachFile.size > 26214400){  //Where 26214400 is byte equivalent of 25MB
			        console.log('Attachment size not supported');
			    }

			    reader.onload = function(e) {
			        var attachment = new sforce.SObject('Attachment');  
			        attachment.Name = attachFile.name;
			        attachment.IsPrivate = false;  
			        attachment.ContentType = attachFile.type;
			        attachment.Body = (new sforce.Base64Binary(e.target.result)).toString();;
			        attachment.Description = attachFile.name;
			        attachment.ParentId = recordID;   //Where recordID is the ID of record to which you want to add your attachment
			        var result = sforce.connection.create([attachment]);  
			        if(result[0].getBoolean("success")){  
			            console.log('file added successfully');
			        }else{
			            console.log('error occured');
			            console.log(result);
			        }
			    };
			    reader.readAsBinaryString(attachFile);
			}
			
			$scope.register = function() {
				console.log('register clicked');
				VFRemotingFactory.registerRecall($scope.formDataAsJSON).then(function(result){
					console.log('registerRecall result = ' + result.Id);
					$scope.addAttachment(result.Id);
				});
			}

			$scope.formData = {};
			$scope.place = {};

			$scope.$watch('formData', function(f) {
				$scope.formDataAsJSON = angular.toJson(f, true);
			},true);

			$scope.$watch('place', function(f) {
				$scope.placeDataAsJSON = angular.toJson(f, true);
				_.forEach($scope.place.address_components, function(value) {
					console.log(value);
					switch (value.types[0]) {
						case 'street_number' : 
							$scope.formData.streetNumber = value.long_name;
							break;
						case 'route' :
							$scope.formData.route = value.long_name;
							break;
						case 'locality' :
							$scope.formData.city = value.long_name;
							break;
						case 'administrative_area_level_1' :
							$scope.formData.state = value.short_name;
							break;
						case 'postal_code' : 
							$scope.formData.postalCode = value.long_name;
							break;
						case 'country' :
							$scope.formData.country = value.long_name;
							break;

					}
				});
				if ($scope.formData.streetNumber != undefined) {
					$scope.formData.street = $scope.formData.streetNumber + ' ' + $scope.formData.route;
				}
			},true);

			$scope.placeCallback = function() {
				$scope.place = this.getPlace();
			}



		});

	</script>
	<apex:slds />
	<body ng-app="StericylcleDemoApp">
		<div class="slds-scope" ng-controller="FormCtrl">
			<div class="slds-grid slds-wrap">
				<div class="slds-size--1-of-1 slds-align_absolute-center">
					<p class="slds-text-heading_large">Stericylcle Demo Recall Form</p>
				</div>
				<div class="slds-size--1-of-1 slds-p-horizontal_medium">
					<div class="slds-form slds-form_compound">
						<fieldset class="slds-form-element">
					      <legend class="slds-form-element__label slds-text-title_caps">Name</legend>
					      <div class="slds-form-element__group">
					        <div class="slds-form-element__row">
					          <div class="slds-form-element slds-size_1-of-2">
					            <label class="slds-form-element__label" for="input-01">First Name</label>
					            <input type="text" ng-model="formData.firstName" id="input-01" class="slds-input"/>
					          </div>
					          <div class="slds-form-element slds-size_1-of-2">
					            <label class="slds-form-element__label" for="input-02">Last Name</label>
					            <input type="text" ng-model="formData.lastName" id="input-02" class="slds-input"/>
					          </div>
					        </div>
					        <div class="slds-form-element__row">
					        	<div class="slds-form-element slds-size_1-of-1">
					        		<label class="slds-form-element__label" for="input-email">E-mail Address</label>
									<input type="text" id="input-email" class="slds-input" ng-model="formData.email"/>
					        	</div>
					        </div>
					      </div>
					    </fieldset>
			
						 <fieldset class="slds-form-element">
      						<legend class="slds-form-element__label slds-text-title_caps">Address</legend>
      							<div class="slds-form-element__group">
      								<div class="slds-form-element__row">
      									<div class="slds-form-element slds-size_1-of-1">
											<label class="slds-form-element__label" for="autocomplete">Google Address Lookup</label>
											<input type="text" places-auto-complete="true" ng-model="formData.gplace" on-place-changed="placeCallback(place)"
								 			 id="autocomplete" types="['geocode']" class="slds-input" placeholder="Enter your address here"/>
      									</div>
      								</div>
      								<div class="slds-form-element__row">
      									<div class="slds-form-element slds-size_1-of-1">
      										<label class="slds-form-element__label" for="autocomplete">Street</label>
      										<input type="text" id="street_number" class="slds-input address" disabled="" ng-model="formData.street"/>
      									</div>

      								</div>
      								<div class="slds-form-element__row">
							          <div class="slds-form-element slds-size_1-of-2">
							            <label class="slds-form-element__label" for="input-04">City</label>
							            <input type="text" id="administrative_area_level_1" class="slds-input" ng-model="formData.city" disabled=""/>
							            
							          </div>
							          <div class="slds-form-element slds-size_1-of-2">
							            <label class="slds-form-element__label" for="input-05">State</label>
							            <input type="text" id="locality" class="slds-input address" ng-model="formData.state" disabled=""/>
							          </div>
							        </div>
							        <div class="slds-form-element__row">
							          <div class="slds-form-element slds-size_1-of-2">
							            <label class="slds-form-element__label" for="input-06">ZIP Code</label>
							            <input type="text" id="postal_code" class="slds-input" ng-model="formData.postalCode" disabled=""/>
							          </div>
							        </div>
      							</div>
      					</fieldset>
						
      					<fieldset class="slds-form-element">
      						<legend class="slds-form-element__label slds-text-title_caps">Recall Information</legend>
  							<div class="slds-form-element__group">
  								<div class="slds-form-element__row">
  									<div class="slds-form-element slds-size_1-of-1">
  										<label class="slds-form-element__label" for="select-product">Product</label>
  										<select class="slds-select" id="select-product" ng-model="formData.product">
											<option>Tylenolz</option>
											<option>Fitbitz</option>
										</select>
  									</div>
  								</div>

  								<div ng-if="formData.product == 'Tylenolz'">
	  								<div class="slds-form-element__row">
	  									<div class="slds-form-element slds-size_1-of-2">
	  										<label class="slds-form-element__label" for="input-name">NDC #</label>	
											<input type="text" id="input-tylenolz-ndc" class="slds-input" ng-model="formData.ndc"/>
	  									</div>
	  									<div class="slds-form-element slds-size_1-of-2">
	  										<label class="slds-form-element__label" for="input-name">Lot #</label>	
											<input type="text" id="input-tylenolz-ndc" class="slds-input" ng-model="formData.lot"/>
	  									</div>
	  								</div>
	  								<div class="slds-form-element__row">
	  									<div class="slds-form-element slds-size_1-of-1">
	  										<label class="slds-form-element__label" for="select-product">Did you become sick after taking Tylenolz?</label>
											<div class="slds-select_container">
												<select class="slds-select" id="select-tylenolz-sick" ng-model="formData.isSick">
													<option value="Yes">Yes</option>
													<option value="No">No</option>
												</select>
											</div>
	  									</div>
  									</div>
  								</div>

  								<div ng-if="formData.product == 'Fitbitz'">
	  								<div class="slds-form-element__row">
	  									<div class="slds-form-element slds-size_1-of-1">
	  										<label class="slds-form-element__label" for="input-fitbitz-serialno">Serial No.</label>
											<input type="text" id="input-fitbitz-serialno" class="slds-input" ng-model="formData.serialno"/>
	  									</div>
	  								</div>
	  								<div class="slds-form-element__row">
	  									<div class="slds-form-element slds-size_1-of-1">
	  										<label class="slds-form-element__label" for="select-fitbitz-returnto">Will you return the product to the retailer or manufacturer? </label>
											<div class="slds-select_container">
												<select class="slds-select" id="select-fitbitz-returnto" ng-model="formData.returnto">
													<option value="Retailer">Retailer</option>
													<option value="Manufacturer">Manufacturer</option>
												</select>
											</div>
	  									</div>
  									</div>
  									<div class="slds-form-element__row" ng-show="formData.returnto == 'Retailer'">
  										<div class="slds-form-element slds-size_1-of-1">
  											<label class="slds-form-element__label" for="select-fitbitz-retailer">Retailer</label>
											<div class="slds-select_container">
												<select class="slds-select" id="select-fitbitz-retailer" ng-model="formData.retailer">
													<option>Amazon</option>
													<option>BestBuy</option>
													<option>CostCo</option>
													<option>Walmart</option>
													<option>Other</option>
												</select>
											</div>
  										</div>
									</div>
									<div class="slds-form-element__row" ng-show="formData.returnto == 'Manufacturer'">
										<div class="slds-form-element slds-size_1-of-1">
											<label class="slds-form-element__label">Product Image</label>
											<div class="slds-file-selector slds-file-selector_files">
										      <div class="slds-file-selector__dropzone">
										        <input type="file" ng-model="formData.file" class="slds-file-selector__input slds-assistive-text" accept="image/png" id="file-upload-input-01" aria-describedby="file-selector-id"/>
										        <label class="slds-file-selector__body" for="file-upload-input-01">
										          <span class="slds-file-selector__button slds-button slds-button_neutral">
										            <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
										              <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#upload')}"></use>
										            </svg>Upload Files</span>
										          <span class="slds-file-selector__text slds-medium-show">or Drop Files</span>
										        </label>
										      </div>
										    </div>
									    </div>
								    </div>
  								</div>
							</div>
						</fieldset>
					</div>
					
				</div>
				<div class="slds-size--1-of-1 slds-align_absolute-center">
					<button class="slds-button slds-button_brand" id="button-register" ng-click="register()">Register</button>
				</div>

				<!--<pre>{{formDataAsJSON}}</pre>
				<pre>{{placeDataAsJSON}}</pre>-->
				
			</div>


		</div>
		
		
		
	</body>
</html>
</apex:page>
